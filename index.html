<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Конструктор тем</title>
</head>
<body>
<h1 id="text_constructor_topic" class="center_text">Конструктор тем</h1>

<div id="select_scene">
    <label class="white_text" for="scenes">Выберите режим:</label>
    <select name="scenes" id="scenes">
        <option value="lecture">Лекция</option>
        <option value="news">Новости</option>
        <option value="friends">Друзья</option>
    </select>
</div>

<textarea id="content" placeholder="Тема сценки..."></textarea>
<div id="result">
    <button id="collect_url" onclick="createPaste()">Собрать ссылку</button>
</div>

<div>
    <h3 class="white_text center_text">Правила!</h3>
    <ul class="white_text">
        <li>Экстремизм, нацизм, межнациональная/религиозная рознь.</li>
        <li>Оскорбления (верующих, ветеранов, власти, любых групп).</li>
        <li>Нелегальные темы (наркотики, оружие, ст. 14.1 КоАП РФ).</li>
        <li>Политика/ЛГБТ (имперсонирование, пропаганда).</li>
        <li>Спам, реклама, абуз символов.</li>
    </ul>
</div>

<script>
    let resultDivOriginal = document.getElementById('result').innerHTML; // Сохраняем исходный HTML
    let url = ""; // Ссылка на пасту (перемещено выше, чтобы избежать ошибки инициализации)

    function sleep(millis) {
        const start = Date.now();
        while (Date.now() - start < millis) {
        }
    }

    function copyURL() {
        navigator.clipboard.writeText(url);
    }

    async function createPaste() {
        const text = document.getElementById('content').value;
        let resultDiv = document.getElementById('result');

        // Восстанавливаем оригинальный HTML и добавляем индикатор загрузки
        resultDiv.innerHTML = resultDivOriginal + '<img id="loading" src="loading.gif" width="120" height="60"/>';

        if (!text) {
            resultDiv.innerHTML = resultDivOriginal + '<label class="white_text">Где текст?</label>';
            return;
        }

        const e = document.getElementById("scenes");
        const text_post = "!" + e.options[e.selectedIndex].value + " " + text;

        try {
            const response = await fetch('https://lesma.eu', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({lesma: text_post})
            });

            if (response.ok) {
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const linkElement = doc.getElementById('link');

                if (linkElement) {
                    url = linkElement.textContent
                        .replace(/&#x2F;/g, '/')
                        .replace(/&amp;/g, '&');

                    sleep(1000);
                    resultDiv.innerHTML = resultDivOriginal + '<button id="get_url" onclick="copyURL()">Скопировать ссылку</button>';
                } else {
                    resultDiv.innerHTML = resultDivOriginal + '<label class="white_text">Ссылка не найдена в ответе</label>';
                }
            } else {
                resultDiv.innerHTML = resultDivOriginal + '<label class="white_text">Ошибка при создании пасты:</label>' + response.status;
            }
        } catch (error) {
            resultDiv.innerHTML = resultDivOriginal + '<label class="white_text">Ошибка сети: ' + error.message + "</label>";
        }
    }


</script>
</body>
</html>