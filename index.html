<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <title>Конструктор тем</title>
</head>
<body>
<h1 id="text_constructor_topic" class="center_text">Конструктор тем</h1>

<textarea id="user_name" class="white_text placeholder" wrap="off" placeholder="Ваш ник..."></textarea>

<div id="select_scene">
    <label class="white_text adaptive_font_size" for="scenes">Выберите режим:</label>
    <select name="scenes" id="sceneSelector" class="white_text selector" id="scenes">
    </select>
</div>

<div id="characterSelectors"></div>

<textarea id="style" class="placeholder white_text" placeholder="Особая настройка..."></textarea>

<textarea id="content" class="placeholder white_text" placeholder="Тема сценки..."></textarea>

<label class="white_text adaptive_font_size" for="number_sentences">Количество предложений:</label>
<input id="number_sentences" class="white_text" value=10 type="number" inputmode="numeric" min=1 max=25 oninput="this.value = this.value.replace(/[^0-9]/g, '')">

<div id="result">
    <button id="collect_url" class="adaptive_font_size" onclick="createJson()">Скопировать json</button>
</div>

<!--<h3 class="white_text center_text">Собранная команда действует не больше 5 минут!</h3>-->

<!--<iframe id="video" src="https://www.youtube.com/embed/QqPDzIXaRtM?si=5fWNP6X5NPeyNCyg" title="YouTube video player"-->
<!--        frameborder="0"-->
<!--        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"-->
<!--        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>-->

<div class="adaptive_font_size">
    <h3 class="white_text center_text">Тема не должна содержать:</h3>
    <ul class="white_text">
        <li>Экстремизм, нацизм, межнациональная/религиозная рознь.</li>
        <li>Оскорбления (верующих, ветеранов, власти, любых групп).</li>
        <li>Нелегальные темы (наркотики, оружие, ст. 14.1 КоАП РФ).</li>
        <li>Политика/ЛГБТ.</li>
        <li>Спам, реклама, абуз символов.</li>
    </ul>
</div>

<script>
    let resultDivOriginal = document.getElementById('result').innerHTML; // Сохраняем исходный HTML
    // let url = ""; // Ссылка на пасту (перемещено выше, чтобы избежать ошибки инициализации)
    // let collect_url = document.getElementById("collect_url");
    // let collect_url_original_text = document.getElementById("collect_url").textContent;
    // const sceneSelector = document.getElementById('sceneSelector');
    let allCharacterSelectors = [];
    //Json данные
    let scenes = [];
    let characters = [];

    document.getElementById('number_sentences').addEventListener('input', function() {
        const min = parseFloat(this.min);
        const max = parseFloat(this.max);
        const value = parseFloat(this.value);

        if (!isNaN(value) && value > max) {
            this.value = max.toFixed(0); // Округляем
        }
        if (!isNaN(value) && value < min) {
            this.value = min; // Округляем
        }
    });


    // Пример загрузки данных
    Promise.all([
        fetch('json/scenes.json').then(res => res.json()),
        fetch('json/characters.json').then(res => res.json())
    ]).then(([scenesData, charactersData]) => {
        scenes = scenesData;
        characters = charactersData;

        const sceneSelector = document.getElementById('sceneSelector');

        // Заполняем список сцен
        scenes.forEach((scene, index) => {
            const option = document.createElement('option');
            option.value = index;  // Сохраняем индекс сцены как значение
            option.textContent = scene.name;
            sceneSelector.appendChild(option);
        });

        // Обработчик изменения выбора сцены
        sceneSelector.addEventListener('change', function() {
            const characterSelectors = document.getElementById('characterSelectors');
            characterSelectors.innerHTML = '';
            allCharacterSelectors = [];

            const selectedScene = scenes[this.value]; // Получаем выбранную сцену

            // Создаем селекторы для каждой роли в сцене
            selectedScene.characters.forEach(role => {
                const container = document.createElement('div');
                container.className = 'role-container';

                const label = document.createElement('label');
                label.className = 'white_text';
                label.textContent = `${role}: `;

                const select = document.createElement('select');
                select.className = 'selector white_text';
                select.id = "character_selector";
                select.innerHTML = '<option value="0">-- Выберите персонажа --</option>';

                // Заполняем персонажами
                characters.forEach(character => {
                    const option = document.createElement('option');
                    option.value = character.id;
                    option.textContent = character.name;
                    select.appendChild(option);
                });

                container.appendChild(label);
                container.appendChild(select);
                characterSelectors.appendChild(container);
                allCharacterSelectors.push(select);

                select.addEventListener('change', checkCharacters);
            });
        });

        sceneSelector.dispatchEvent(new Event('change'));
    });

    function checkCharacters() {
        // Собираем все выбранные значения (кроме 0)
        const values = new Map();
        allCharacterSelectors.forEach(select => {
            const value = select.value;
            if (value !== "0") {
                values.set(value, (values.get(value) || 0) + 1);
            }
        });

        // Находим дубликаты
        const duplicates = [];
        for (const [value, count] of values) {
            if (count > 1) duplicates.push(value);
        }

        // Сбрасываем дубликаты и нулевые значения не трогаем
        if (duplicates.length > 0) {

            allCharacterSelectors.forEach(select => {
                if (duplicates.includes(select.value) && select.value !== "0") {
                    select.value = "0"; // Сброс на значение по умолчанию
                    duplicates.splice(select.value, 1);
                    console.log(`Дубликат найден: ${select.id} сброшен`);
                }
            });
        }
    }

    function checkValid(){
        const values = new Map();
        allCharacterSelectors.forEach(select => {
            const value = select.value;
            if (value !== "0") {
                values.set(value, (values.get(value) || 0) + 1);
            }
        });

        for (const select of allCharacterSelectors) {
            if (select.value === "0") {
                return "Не выбран персонаж(и)"
            }
        }

        if (document.getElementById("content").value.trim() === "")
        {
            return "Не указана тема"
        }

        return "Подходит"
    }

    async function copyJsonAnimation() {
        const original_color = document.getElementById("collect_url").style.backgroundColor;
        const original_text = document.getElementById("collect_url").textContent;

        document.getElementById("collect_url").style.backgroundColor = "#4e90e6";
        document.getElementById("collect_url").textContent = "Скопировано!";
        document.getElementById("collect_url").disabled = true;

        await new Promise(r => setTimeout(r, 1000));

        document.getElementById("collect_url").style.backgroundColor = original_color;
        document.getElementById("collect_url").textContent = original_text;
        document.getElementById("collect_url").disabled = false;
    }

    const text = document.getElementById('content').value;
    let resultDiv = document.getElementById('result');

    function createJson(){
        let result = checkValid();
        if(result !== "Подходит"){
            if (!text) {
                resultDiv.innerHTML = resultDivOriginal + '<label class="white_text" class="adaptive_font_size">' + result +'</label>';
            }

            return;
        }
        resultDiv.innerHTML = resultDivOriginal;

        const characters = [];
        allCharacterSelectors.forEach(select => {
            characters.push(select[select.value].textContent)
        });

        const e = document.getElementById("sceneSelector");

        const data = {
            username: document.getElementById("user_name").value,
            characters: characters,
            style: document.getElementById("style").value,
            size: document.getElementById("number_sentences").value,
            topic: "!" + e.options[e.selectedIndex].textContent + " " + document.getElementById("content").value
        };

        const jsonString = JSON.stringify(data, null, 2); // Красивое форматирование

        navigator.clipboard.writeText(jsonString);

        copyJsonAnimation()
    }

//     async function createPaste() {
//         const text = document.getElementById('content').value;
//         let resultDiv = document.getElementById('result');
//
//
//         // Восстанавливаем оригинальный HTML и добавляем индикатор загрузки
//         resultDiv.innerHTML = resultDivOriginal + '<img id="loading" src="images/loading.gif"/>';
//
//         if (!text) {
//             resultDiv.innerHTML = resultDivOriginal + '<label class="white_text" class="adaptive_font_size">Где текст?</label>';
//             return;
//         }
//
//         document.getElementById("collect_url").textContent = "Думаю...";
//         document.getElementById("collect_url").disabled = true;
//         document.getElementById("collect_url").style.backgroundColor = "#282B30FF"; // HEX-код
//
//         const e = document.getElementById("scenes");
//         const text_post = "!" + e.options[e.selectedIndex].value + " " + text;
//
//         try {
//             const response = await fetch('https://lesma.eu', {
//                 method: 'POST',
//                 headers: {'Content-Type': 'application/x-www-form-urlencoded'},
//                 body: new URLSearchParams({lesma: text_post})
//             });
//
//             if (response.ok) {
//                 const html = await response.text();
//                 const parser = new DOMParser();
//                 const doc = parser.parseFromString(html, 'text/html');
//                 const linkElement = doc.getElementById('link');
//
//                 if (linkElement) {
//                     const urlString = linkElement.textContent
//                         .replace(/&#x2F;/g, '/')
//                         .replace(/&amp;/g, '&');
//
// // Создаем объект URL
//                     const urlObj = new URL(urlString);
//                     const pasteId = urlObj.pathname.substring(1);
//
//                     url = "!paste " + pasteId;
//
//                     sleep(1000);
//                     collect_url.textContent = collect_url_original_text;
//                     resultDiv.innerHTML = resultDivOriginal + '<button id="get_url"  class="adaptive_font_size" onclick="copyJsonAnimation()">Скопировать команду</button>';
//                     document.getElementById("collect_url").disabled = false;
//
//                 } else {
//                     resultDiv.innerHTML = resultDivOriginal + '<label class="white_text" class="adaptive_font_size">Ссылка не найдена в ответе</label>';
//                 }
//             } else {
//                 resultDiv.innerHTML = resultDivOriginal + '<label class="white_text" class="adaptive_font_size">Ошибка при создании пасты:</label>' + response.status;
//             }
//         } catch (error) {
//             resultDiv.innerHTML = resultDivOriginal + '<label class="white_text" class="adaptive_font_size">Ошибка сети: ' + error.message + "</label>";
//         }
//     }


</script>
</body>
</html>