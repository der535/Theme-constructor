<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=2.0, user-scalable=no">
    <title>Конструктор тем</title>
    <!-- Добавлены шрифты -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="header">
        <h1 id="text_constructor_topic" class="center_text">Конструктор тем</h1>
    </div>

    <div class="card">
        <div class="input-group">
            <label class="white_text">Ваш ник:</label>
            <textarea id="user_name" class="placeholder white_text" wrap="off" placeholder="Введите ваш ник..."></textarea>
        </div>

        <div class="input-group">
            <label class="white_text adaptive_font_size">Выберите режим:<span class="required-star">*</span></label>
            <select name="scenes" id="scene_selector" class="white_text selector"></select>
        </div>

<!--        <div id="scene_preview_container" class="preview-container">-->
<!--            <img id="scene_preview" src="" alt="Превью сцены" class="scene-preview hidden">-->
<!--        </div>-->


        <label class="white_text adaptive_font_size">Персонажи:<span class="required-star">*</span></label>
        <div id="characterSelectors" class="character-grid"></div>

        <div class="checkbox-group">
            <input type="checkbox" id="manualMode" value="Bike">
            <label for="manualMode" class="white_text"> Ручной режим</label>
        </div>

        <div class="input-group animated-toggle" id="content-group">
            <label class="white_text adaptive_font_size">Тема сценки:<span class="required-star">*</span></label>
            <textarea id="content" class="placeholder white_text" placeholder="Введите текст..."></textarea>
        </div>

        <div class="input-group animated-toggle" id="scenario-group">
            <label class="white_text adaptive_font_size">Cценарий:<span class="required-star">*</span></label>
            <textarea id="your_scenario" class="placeholder white_text" placeholder="Ваш сценарий..."></textarea>
        </div>

        <div class="input-group animated-toggle" id="number-sentences-group">
            <label class="white_text adaptive_font_size" for="number_sentences">Количество предложений:<span class="required-star">*</span></label>
            <input id="number_sentences" class="white_text" value="10" type="number" inputmode="numeric" min="1" max="25">
        </div>

        <!-- Особая настройка -->
        <div class="input-group animated-toggle" id="style-group">
            <label class="white_text adaptive_font_size">Особая настройка сценария:</label>
            <select id="style_preset_selector" class="selector white_text">
                <option value="">-- Выберите шаблон --</option>
            </select>
            <textarea id="style" class="placeholder white_text" placeholder="Введите текст..."></textarea>
        </div>

        <!-- Настройка картинок -->
        <div class="input-group animated-toggle">
            <label class="white_text adaptive_font_size">Особая настройка картинок:</label>
            <select id="style_image_preset_selector" class="selector white_text">
                <option value="">-- Выберите шаблон картинки --</option>
            </select>
            <textarea id="style-image" class="placeholder white_text" placeholder="Введите текст..."></textarea>
        </div>

        <!-- Настройка произношения -->
        <div class="input-group animated-toggle">
            <label class="white_text adaptive_font_size">Особая настройка произношения текста:</label>
            <select id="style_speech_preset_selector" class="selector white_text">
                <option value="">-- Выберите шаблон произношения --</option>
            </select>
            <textarea id="style-speech" class="placeholder white_text" placeholder="Введите текст..."></textarea>
        </div>





        <div id="result" class="result-container">
            <button id="collect_url" class="adaptive_font_size" onclick="createJson()">Скопировать json</button>
        </div>
    </div>

    <div class="card action-section">
        <label id="send_data_text" class="white_text section-title">Отправить данные для генерации:</label>
        <div id="queue_buttons" class="button-group">
            <button id="premium_queue" class="black_text premium-btn" onclick="window.open('https://www.donationalerts.com/r/mrwh1te', '_blank')">Премиум очередь</button>
            <button id="free_queue" class="black_text free-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSdyAKibyOKJ7feW517n2ycfExsEHAO1422vv8RLpsvqDWkRiA/viewform?usp=header', '_blank')">Бесплатная очередь</button>
        </div>

        <div class="telegram-section">
            <label id="watch_scenes" class="white_text section-title">Посмотреть сценки:</label>
            <button id="telegramm_button" class="black_text telegram-btn" onclick="window.open('https://t.me/ai_smehotron_live', '_blank')">Телеграм канал</button>
        </div>
    </div>

    <div class="card rules-section">
        <h3 class="white_text center_text">Тема не должна содержать:</h3>
        <ul class="white_text rules-list">
            <li>Экстремизм, нацизм, межнациональная/религиозная рознь.</li>
            <li>Оскорбления (верующих, ветеранов, власти, и т.д).</li>
            <li>Нелегальные темы (наркотики, оружие, и т.д).</li>
            <li>Политика/ЛГБТ.</li>
            <li>Спам, реклама.</li>
        </ul>
        <div class="warning-note">
            <label class="white_text">Я буду пропускать темы, которые нарушают правила</label>
        </div>
    </div>
</div>

<script>
    function updateFields() {
        const manual = document.getElementById('manualMode').checked;

        const toggleBlock = (id, show) => {
            const el = document.getElementById(id);
            if (show) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        toggleBlock('scenario-group', manual);
        toggleBlock('style-group', !manual);
        toggleBlock('number-sentences-group', !manual);
        toggleBlock('content-group', !manual);
    }




    document.getElementById('manualMode').addEventListener('change', updateFields);
    document.addEventListener('DOMContentLoaded', () => {
        updateFields();

        // Настройка всех пресетов
        setupPresets({
            jsonPath: 'json/style_presets.json',
            selectorId: 'style_preset_selector',
            textareaId: 'style'
        });
        setupPresets({
            jsonPath: 'json/style_image_presets.json',
            selectorId: 'style_image_preset_selector',
            textareaId: 'style-image'
        });
        setupPresets({
            jsonPath: 'json/style_speech_presets.json',
            selectorId: 'style_speech_preset_selector',
            textareaId: 'style-speech'
        });
    });

    let resultDivOriginal = document.getElementById('result').innerHTML;
    let allCharacterSelectors = [];
    let scenes = [];
    let characters = [];

    document.getElementById('number_sentences').addEventListener('input', function () {
        const min = parseFloat(this.min);
        const max = parseFloat(this.max);
        const value = parseFloat(this.value);
        if (!isNaN(value) && value > max) {
            this.value = max.toFixed(0);
        }
        if (!isNaN(value) && value < min) {
            this.value = min;
        }
    });

    Promise.all([
        fetch('json/scenes.json').then(res => res.json()),
        fetch('json/characters.json').then(res => res.json())
    ]).then(([scenesData, charactersData]) => {
        scenes = scenesData;
        characters = charactersData;
        const scene_selector = document.getElementById('scene_selector');
        scenes.forEach((scene, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = scene.name;
            scene_selector.appendChild(option);
        });

        scene_selector.addEventListener('change', function () {
            const characterSelectors = document.getElementById('characterSelectors');
            characterSelectors.innerHTML = '';
            allCharacterSelectors = [];
            const selectedScene = scenes[this.value];
            // const previewImage = document.getElementById('scene_preview');
            // if (selectedScene.preview) {
            //     previewImage.src = selectedScene.preview;
            //     previewImage.classList.remove('hidden');
            // } else {
            //     previewImage.classList.add('hidden');
            // }

            selectedScene.characters.forEach(role => {
                const container = document.createElement('div');
                container.className = 'role-container';
                const label = document.createElement('label');
                label.className = 'white_text';
                label.textContent = `${role}: `;
                const select = document.createElement('select');
                select.className = 'selector white_text';
                select.id = 'character_selector';
                select.innerHTML = '<option value="0">-- Выберите персонажа --</option>';
                characters.forEach(character => {
                    const option = document.createElement('option');
                    option.value = character.id;
                    option.textContent = character.name;
                    select.appendChild(option);
                });
                container.appendChild(label);
                container.appendChild(select);
                characterSelectors.appendChild(container);
                allCharacterSelectors.push(select);
                select.addEventListener('change', checkCharacters);
            });
        });

        scene_selector.dispatchEvent(new Event('change'));
    });

    function checkCharacters() {
        const values = new Map();
        allCharacterSelectors.forEach(select => {
            const value = select.value;
            if (value !== "0") {
                values.set(value, (values.get(value) || 0) + 1);
            }
        });
        const duplicates = [];
        for (const [value, count] of values) {
            if (count > 1) duplicates.push(value);
        }
        if (duplicates.length > 0) {
            allCharacterSelectors.forEach(select => {
                if (duplicates.includes(select.value) && select.value !== "0") {
                    select.value = "0";
                }
            });
        }
    }

    function checkValid() {
        const values = new Map();
        allCharacterSelectors.forEach(select => {
            const value = select.value;
            if (value !== "0") {
                values.set(value, (values.get(value) || 0) + 1);
            }
        });
        for (const select of allCharacterSelectors) {
            if (select.value === "0") {
                return "Не выбран персонаж(и)";
            }
        }
        if (!document.getElementById("manualMode").checked) {
            if (document.getElementById("content").value.trim() === "") {
                return "Не указана тема";
            }
        } else {
            if (document.getElementById("your_scenario").value.trim() === "") {
                return "Не указан сценарий";
            }
        }
        return "Подходит";
    }

    async function copyJsonAnimation() {
        const btn = document.getElementById("collect_url");
        const originalColor = btn.style.backgroundColor;
        const originalText = btn.textContent;
        btn.style.backgroundColor = "#2d5b98";
        btn.textContent = "Скопировано!";
        btn.disabled = true;
        await new Promise(r => setTimeout(r, 1000));
        btn.style.backgroundColor = originalColor;
        btn.textContent = originalText;
        btn.disabled = false;
    }

    function createJson() {
        let result = checkValid();
        if (result !== "Подходит") {
            document.getElementById('result').innerHTML =
                resultDivOriginal +
                '<label class="white_text adaptive_font_size">' + result + '</label>';
            return;
        }
        document.getElementById('result').innerHTML = resultDivOriginal;
        const charactersList = [];
        allCharacterSelectors.forEach(select => {
            charactersList.push(select[select.value].textContent);
        });
        const e = document.getElementById("scene_selector");
        let data;
        let user_name;
        if(document.getElementById("user_name").value === ''){
            user_name = "Аноним";
        }
        else {
            user_name = document.getElementById("user_name").value;
        }

        if (document.getElementById('manualMode').checked) {
            data = {
                username: user_name,
                characters: charactersList,
                style: "",
                size: 0,
                topic: "",
                scenario: document.getElementById("your_scenario").value
                    .split('\n')
                    .map(line => `(${charactersList[0]}) ${line}`)
                    .join('\n'),
                scene: e.options[e.selectedIndex].textContent
            };
        } else {
            data = {
                username: user_name,
                characters: charactersList,
                style: document.getElementById("style").value,
                style_image: document.getElementById("style-image").value,
                style_speech: document.getElementById("style-speech").value,
                size: document.getElementById("number_sentences").value,
                topic: document.getElementById("content").value,
                scenario: "",
                scene: e.options[e.selectedIndex].textContent
            };
        }
        const jsonString = JSON.stringify(data, null, 2);
        navigator.clipboard.writeText(jsonString);
        copyJsonAnimation();
    }

    function setupPresets({ jsonPath, selectorId, textareaId }) {
        fetch(jsonPath)
            .then(res => res.json())
            .then(presets => {
                const selector = document.getElementById(selectorId);
                presets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.description;
                    option.textContent = preset.name;
                    selector.appendChild(option);
                });

                selector.addEventListener('change', function () {
                    const textarea = document.getElementById(textareaId);
                    if (this.value !== "") {
                        textarea.value = this.value;
                    }
                });

                const textarea = document.getElementById(textareaId);
                textarea.addEventListener('input', function () {
                    if (selector.selectedIndex !== 0) {
                        selector.selectedIndex = 0;
                    }
                });
            })
            .catch(err => console.error(`Ошибка загрузки ${jsonPath}:`, err));
    }
</script>


</body>
</html>